apiVersion: v1
kind: Namespace
metadata:
  name: flask-app
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: flask-app
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
    }

        http {
                # Inline MIME types to avoid external file dependency in ConfigMap mounts
                types {
                    text/html                             html htm shtml;
                    text/css                              css;
                    text/xml                              xml;
                    image/gif                             gif;
                    image/jpeg                            jpeg jpg;
                    application/javascript                js;
                    application/atom+xml                  atom;
                    application/rss+xml                   rss;
                    text/mathml                           mml;
                    text/plain                            txt;
                    text/vnd.sun.j2me.app-descriptor      jad;
                    text/vnd.wap.wml                      wml;
                    text/x-component                      htc;
                    image/png                             png;
                    image/tiff                            tif tiff;
                    image/vnd.wap.wbmp                    wbmp;
                    image/x-icon                          ico;
                    image/x-jng                           jng;
                    image/x-ms-bmp                        bmp;
                    application/java-archive              jar war ear;
                    application/mac-binhex40              hqx;
                    application/msword                    doc;
                    application/pdf                       pdf;
                    application/postscript                ps eps ai;
                    application/rtf                       rtf;
                    application/vnd.ms-excel              xls;
                    application/vnd.ms-powerpoint         ppt;
                    application/vnd.wap.wmlc              wmlc;
                    application/vnd.google-earth.kml+xml  kml kmz;
                    application/zip                       zip;
                    application/octet-stream             bin exe dll;
                }
                default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        log_format json_combined escape=json
        '{'
            '"time_local":"$time_local",'
            '"remote_addr":"$remote_addr",'
            '"request":"$request",'
            '"status": "$status",'
            '"body_bytes_sent":"$body_bytes_sent"'
        '}';

        access_log /var/log/nginx/access.log main;
        sendfile on;
        tcp_nopush on;
        keepalive_timeout 65;

        upstream flask_backend {
            server flask-service:5000;
        }

        server {
            listen 80;
            server_name _;

            location / {
                proxy_pass http://flask_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
    }

  default.conf: |
    upstream flask_backend {
        server flask-service:5000;
    }

    server {
        listen 80;
        server_name _;
        access_log /var/log/nginx/access.log main;

        location / {
            proxy_pass http://flask_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }

    mime.types: |
        types {
            text/html                             html htm shtml;
            text/css                              css;
            text/xml                              xml;
            image/gif                             gif;
            image/jpeg                            jpeg jpg;
            application/javascript                js;
            application/atom+xml                  atom;
            application/rss+xml                   rss;
            text/mathml                           mml;
            text/plain                            txt;
            text/vnd.sun.j2me.app-descriptor      jad;
            text/vnd.wap.wml                      wml;
            text/x-component                      htc;
            image/png                             png;
            image/tiff                            tif tiff;
            image/vnd.wap.wbmp                    wbmp;
            image/x-icon                          ico;
            image/x-jng                           jng;
            image/x-ms-bmp                        bmp;
            application/java-archive              jar war ear;
            application/mac-binhex40              hqx;
            application/msword                    doc;
            application/pdf                       pdf;
            application/postscript                ps eps ai;
            application/rtf                       rtf;
            application/vnd.ms-excel              xls;
            application/vnd.ms-powerpoint         ppt;
            application/vnd.wap.wmlc              wmlc;
            application/vnd.google-earth.kml+xml  kml kmz;
            application/zip                       zip;
            application/octet-stream             bin exe dll;
        }
